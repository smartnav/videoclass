// const socket = io('http://localhost:4000/');
const socket = io('https://socket.kidatcode.com');

// Alert With Input Type
$("body").on("click", "#redirectLink", function (e) {
    let current = $(this);
    swal({
        title: "Enter your name",
        input: "text",
        inputPlaceholder: "Jhon Doe",
        showCancelButton: true,
        confirmButtonText: "Submit",
        allowOutsideClick: true,
    }).then((result) => {
        if (result.value) {
            location.href =
                "https://smartnav.github.io/videoclass/videoModule/student.html?role=" +
                current.data("type") +
                "&name=" +
                result.value;
        }
    });
});

$("body").on("click", ".header #people", function () {
    $(".chatBox").addClass("showPeopleList");
    $(".chatBox").removeClass("showMsgBox");
});

$("body").on("click", ".header #chat", function () {
    $(".chatBox").removeClass("showPeopleList");
    $(".chatBox").addClass("showMsgBox");
});

// new change start

$("body").on("click", ".chatBox .close", function () {
    $(".chatBox").removeClass("show");
});

$("body").on("click", "#toggleChatBox", function () {
    $(".chatBox").addClass("show");
    $(".header #chat").trigger("click");
});


$("body").on("click", "#togglePeopleBox", function () {
    $(".chatBox").addClass("show");
    $(".header #people").trigger("click");
});
// new change end
var messageCount = 0;
$("body").on("click", ".chatBox .msgBox .footer button", function () {
    // alert(options.name)
    $("#messageCount").html(0);
    options.msg = $(".chatBox .msgBox input").val();
    let imgSrc = "img/boy.png";
    let userName = options.name;
    $(".chatBox .msgBox input").val("");
    $(".chatBox .msgBox input").focus();
    socket.emit('sendMessage', options);
    printMsg(userName, imgSrc, options.msg, true);
});

$( "#target" ).keypress(function() {
     // alert(options.name)
     var keycode = (event.keyCode ? event.keyCode : event.which);
    if(keycode == '13'){
        $("#messageCount").html(0);
        options.msg = $(".chatBox .msgBox input").val();
        let imgSrc = "img/boy.png";
        let userName = options.name;
        $(".chatBox .msgBox input").val("");
        $(".chatBox .msgBox input").focus();
        socket.emit('sendMessage', options);
        printMsg(userName, imgSrc, options.msg, true);
    }
  });

socket.on('receiveMessage', (receiveData)=>{
  messageCount = messageCount+1;
  $("#messageCount").html(messageCount);
  const messageAudio = new Audio("audio/juntos.mp3");
        messageAudio.play(); 
        let imgSrc = "img/boy.png";
        printMsg(receiveData.name, imgSrc, receiveData.msg, false);
})

socket.on('receiveMessageEmoji', (receiveData)=>{
    messageCount = messageCount+1;
    $("#messageCount").html(messageCount);
    const messageAudio = new Audio("audio/juntos.mp3");
          messageAudio.play(); 
          let imgSrc = "img/boy.png";
          sendEmoji(receiveData.name, imgSrc, receiveData.emoji, false);
  })

function printMsg(name, img, msg, isSender) {
    let html = "";
    if(isSender){
        
    html +=
        '<!-- msg start --><div class="sent"><div class="nameMsg"><div class="name">' +
        name +
        '</div><div class="msg">' +
        msg +
        '</div></div><div class="userIcon"><img src="' +
        img +
        '" alt="receiver image"></div></div><!-- msg end -->';
    }else{
        html +=`<div class="received">
                    <div class="userIcon">
                        <img src="img/boy.png" alt="receiver image" />
                    </div>
                    <div class="nameMsg">
                        <div class="name">${name}</div>
                        <div class="msg">
                            ${msg}
                        </div>
                    </div>
                </div>`
    }
    
    if (msg.length) {
        $(".chatBox .msgBox .messages").append(html);
        let ch = $(".chatBox .msgBox .messages").children("div").length;
        let ht = ch * 80;
        $(".chatBox .msgBox .messages").animate({ scrollTop: ht }, 250);
        let countBox = $(".video .videoMenu .notification .count");
        let count = parseInt(countBox.text());
        countBox.text(count + 1);
    }
}

$("body").on("click", ".chatBox .msgBox .footer .toggleEmoji", function () {
    $(".chatBox .msgBox .footer .emojisBox").slideToggle();
});

$("body").on("click", ".chatBox .msgBox .footer .emojisBox img", function () {
    let imgSrc = "img/boy.png";
    let userName = options.name;
    options.emoji = $(this).attr("src");
    socket.emit('sendMessageEmoji', options);
    
    $(".chatBox .msgBox .footer .emojisBox").slideToggle();
    sendEmoji(userName, imgSrc, options.emoji, true);
});


function sendEmoji(name, img, emoji, isSender) {

    let html = "";
    if(isSender){
    html +=
        '<!-- msg start --><div class="sent"><div class="nameMsg"><div class="name">' +
        name +
        '</div><div class="msg"><img src="' +
        emoji +
        '" alt="Emoji"/></div></div><div class="userIcon"><img src="' +
        img +
        '" alt="receiver image"></div></div><!-- msg end -->';
    }else{
        html +=`<div class="received">
                    <div class="userIcon">
                        <img src="img/boy.png" alt="receiver image" />
                    </div>
                    <div class="nameMsg">
                        <div class="name">${name}</div>
                        <div class="msg"><img src="
                            ${emoji}" alt="Emoji"/>
                        </div>
                    </div>
                </div>`
    }
    if (emoji.length) {
        $(".chatBox .msgBox .messages").append(html);
        let ch = $(".chatBox .msgBox .messages").children("div").length;
        let ht = ch * 80;
        $(".chatBox .msgBox .messages").animate({ scrollTop: ht }, 250);
        let countBox = $(".video .videoMenu .notification .count");
        let count = parseInt(countBox.text());
        countBox.text(count + 1);
    }
}
